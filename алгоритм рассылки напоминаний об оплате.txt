мониторим все события по записям от сегодня и далее

 


[‎22.‎04.‎2020 17:21]  Зубов Владимир Михайлович:  
s.createdate between dateadd(minute, -30, current_timestamp) and dateadd(minute, 30, current_timestamp) 

1 событие - появилась новая запись на телемедицину
если (amount_payable != paid_by_client) 
1.1 услуга запланирована и online_account = нет, то клиент записался через КЦ, отправить сообщение менеджеру для оплаты через яндекс-деньги
1.2 услуга запланирована и online_account = да, то клиент записался через КЦ, отправить сообщение менеджеру для оплаты через ЛК
1.3 предсчет и online_account = да - пропускаем, пациент оплатит самостоятельно
1.4 предсчет и online_account = нет - клиент записался через ЛК, нет доступа к оплате, отправить менеджеру сообщение для оплаты через яндекс-деньги





s.workdate = current_date and datediff(minute, current_time, dateadd(minute, S.BHOUR * 60 + S.BMIN, cast('00:00' as time))) between 0 and 30 

2 событие - за 30 минут до начала
если amount_payable != paid_by_client - клиент не оплатил прием, который скоро начнется, отправить сообщение менеджеру
